<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Car Advisor - NextCar Concierge</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://js.stripe.com/v3/"></script>
</head>
<body style="font-family: 'Inter', sans-serif; background-color: #050A14; color: #ffffff; margin: 0; padding: 20px;">

<div style="max-width: 800px; margin: 0 auto; background-color: #0A1525; border-radius: 12px; padding: 20px;">
    <!-- Header -->
    <div style="background: linear-gradient(135deg, #D4AF37 0%, #B8961F 100%); color: #050A14; padding: 20px; text-align: center; border-radius: 12px; margin-bottom: 20px;">
        <h1>ü§ñ AI Car Advisor</h1>
        <p>64 years of automotive expertise at your fingertips</p>
    </div>

    <!-- Welcome Message -->
    <div id="welcomeMessage" style="text-align: center; padding: 40px 20px; color: #B0B6C3;">
        <h2 style="color: #D4AF37; margin-bottom: 10px;">Welcome to Your AI Car Advisor!</h2>
        <p style="margin-bottom: 20px;">I'll help you find the perfect car based on your needs, budget, and lifestyle.</p>
        
        <div style="display: flex; flex-direction: column; gap: 10px; max-width: 400px; margin: 0 auto;">
            <button onclick="startChat('I need help choosing a car for my family in Des Moines')" style="background-color: rgba(212, 175, 55, 0.1); border: 1px solid rgba(212, 175, 55, 0.3); color: #D4AF37; padding: 10px 16px; border-radius: 12px; cursor: pointer;">
                üöó Family car recommendations
            </button>
            <button onclick="startChat('What is the best car for my daily commute in Iowa?')" style="background-color: rgba(212, 175, 55, 0.1); border: 1px solid rgba(212, 175, 55, 0.3); color: #D4AF37; padding: 10px 16px; border-radius: 12px; cursor: pointer;">
                üõ£Ô∏è Best for commuting  
            </button>
            <button onclick="startChat('I want a reliable car under $25,000 in my area')" style="background-color: rgba(212, 175, 55, 0.1); border: 1px solid rgba(212, 175, 55, 0.3); color: #D4AF37; padding: 10px 16px; border-radius: 12px; cursor: pointer;">
                üí∞ Budget-friendly options
            </button>
        </div>
    </div>

    <!-- Chat Messages -->
    <div id="chatMessages" style="min-height: 300px; max-height: 500px; overflow-y: auto; padding: 20px; background-color: #050A14; border-radius: 12px; margin-bottom: 20px;">
        <!-- Messages will appear here -->
    </div>

    <!-- Typing Indicator -->
    <div id="typingIndicator" style="display: none; padding: 10px 20px; background-color: rgba(212, 175, 55, 0.1); border-radius: 12px; margin-bottom: 20px;">
        <span style="color: #D4AF37;">AI is typing...</span>
    </div>

    <!-- Chat Input -->
    <div style="display: flex; gap: 10px; align-items: center;">
        <input type="text" id="messageInput" placeholder="Tell me about your car needs..." style="flex: 1; padding: 12px 16px; background-color: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 20px; color: #ffffff; font-size: 1rem;">
        <button onclick="sendUserMessage()" style="background-color: #D4AF37; color: #050A14; border: none; border-radius: 50%; width: 44px; height: 44px; cursor: pointer; font-size: 1.2rem;">
            ‚û§
        </button>
    </div>

    <!-- Results Section -->
    <div id="resultsSection" style="display: none; margin-top: 30px; padding: 20px; background-color: #050A14; border-radius: 12px;">
        <h2 style="color: #D4AF37; text-align: center; margin-bottom: 20px;">üéØ Your Perfect Car Matches</h2>
        <div id="recommendationsContainer"></div>
        
        <div style="background: linear-gradient(135deg, #D4AF37 0%, #B8961F 100%); color: #050A14; padding: 20px; border-radius: 12px; text-align: center; margin-top: 30px;">
            <h3>Want us to handle everything?</h3>
            <p>Let our experts find, negotiate, and deliver your perfect car. Skip the dealership entirely.</p>
            <button onclick="upgradeToFullService()" style="background-color: #050A14; color: #D4AF37; padding: 12px 24px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                Upgrade to Premium Concierge - $549 ‚Üí
            </button>
        </div>
    </div>
</div>

<script>
// Initialize Stripe
const stripe = Stripe('pk_test_51RjN6RCSrwRSSwuqrcimJXZOwVvCxp45XUISpSRc26hnzg9RpN2WncZVj3ntpsUrLyUOF94OdMRyjAwTqMFrvzbG0045mUlr9Q');

// Global variables
let conversationHistory = [];
let isProcessing = false;
let searchResults = [];

// Core functions - defined at the top
function startChat(message) {
    document.getElementById('welcomeMessage').style.display = 'none';
    showMessage('user', message);
    processAIMessage(message);
}

function sendUserMessage() {
    const input = document.getElementById('messageInput');
    const message = input.value.trim();
    
    if (!message || isProcessing) return;
    
    document.getElementById('welcomeMessage').style.display = 'none';
    showMessage('user', message);
    input.value = '';
    processAIMessage(message);
}

function showMessage(sender, content) {
    const messagesContainer = document.getElementById('chatMessages');
    const messageDiv = document.createElement('div');
    
    const isUser = sender === 'user';
    const avatarText = isUser ? 'You' : 'AI';
    const bgColor = isUser ? 'rgba(79, 70, 229, 0.2)' : 'rgba(212, 175, 55, 0.1)';
    
    messageDiv.innerHTML = `
        <div style="display: flex; gap: 12px; margin-bottom: 20px; ${isUser ? 'flex-direction: row-reverse;' : ''}">
            <div style="width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; background-color: ${isUser ? '#4f46e5' : '#D4AF37'}; color: ${isUser ? 'white' : '#050A14'}; flex-shrink: 0;">
                ${avatarText}
            </div>
            <div style="background-color: ${bgColor}; padding: 12px 16px; border-radius: 18px; max-width: 70%; line-height: 1.5;">
                ${content}
            </div>
        </div>
    `;
    
    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function showTyping() {
    document.getElementById('typingIndicator').style.display = 'block';
}

function hideTyping() {
    document.getElementById('typingIndicator').style.display = 'none';
}

async function processAIMessage(message) {
    if (isProcessing) return;
    
    isProcessing = true;
    showTyping();
    
    conversationHistory.push({
        role: 'user',
        content: message
    });

    try {
        const response = await fetch('/api/chat-enhanced', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                messages: conversationHistory,
                chatToken: localStorage.getItem('chatToken')
            })
        });
        
        const data = await response.json();
        
        hideTyping();
        showMessage('ai', data.message);
        
        if (data.searchResults && data.searchResults.length > 0) {
            searchResults = data.searchResults;
            console.log('Search results received:', searchResults.length, 'listings');
        }
        
        conversationHistory.push({
            role: 'assistant',
            content: data.message
        });
        
        if (data.readyForRecommendations) {
            setTimeout(showResults, 1000);
        }
        
    } catch (error) {
        hideTyping();
        showMessage('ai', 'I apologize, but I encountered an error. Please try again or contact support.');
        console.error('Chat error:', error);
    }
    
    isProcessing = false;
}

async function showResults() {
    try {
        const response = await fetch('/api/recommendations-enhanced', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                messages: conversationHistory,
                chatToken: localStorage.getItem('chatToken'),
                searchResults: searchResults
            })
        });
        
        const data = await response.json();
        displayResults(data.recommendations, data.searchPerformed);
        
    } catch (error) {
        console.error('Error getting recommendations:', error);
    }
}

function displayResults(recommendations, searchPerformed) {
    document.getElementById('resultsSection').style.display = 'block';
    
    const container = document.getElementById('recommendationsContainer');
    
    const recommendationsHTML = recommendations.map(car => `
        <div style="background-color: rgba(255, 255, 255, 0.05); border-radius: 12px; padding: 20px; margin-bottom: 20px; border-left: 4px solid #D4AF37;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                <h3 style="color: #ffffff; margin: 0;">${car.title}</h3>
                <span style="color: #D4AF37; font-size: 0.9rem;">${car.source || 'Expert Database'}</span>
            </div>
            
            <div style="color: #D4AF37; font-size: 1.1rem; font-weight: 600; margin-bottom: 15px;">
                ${car.estimatedPrice || car.marketPrice || 'Contact for pricing'}
            </div>
            
            <div style="margin-bottom: 15px;">
                <strong style="color: #D4AF37;">Why this car:</strong>
                <p style="margin: 5px 0; color: #B0B6C3;">${car.whyPerfectMatch || car.whyRecommended || 'Perfect match for your needs'}</p>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px;">
                ${car.url && car.url !== '#' ? 
                    `<a href="${car.url}" target="_blank" style="background-color: #D4AF37; color: #050A14; padding: 10px 15px; text-decoration: none; border-radius: 8px; text-align: center; font-weight: 600;">View Listing ‚Üí</a>` :
                    `<button onclick="searchCar('${car.title}')" style="background-color: #D4AF37; color: #050A14; padding: 10px 15px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">Search for This Car ‚Üí</button>`
                }
                <button onclick="contactDealer('${car.title}')" style="background-color: transparent; color: #D4AF37; padding: 10px 15px; border: 2px solid #D4AF37; border-radius: 8px; font-weight: 600; cursor: pointer;">
                    Contact Dealer
                </button>
            </div>
        </div>
    `).join('');
    
    container.innerHTML = recommendationsHTML;
    
    // Scroll to results
    document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
}

function searchCar(carTitle) {
    const searchQuery = encodeURIComponent(carTitle + ' Iowa for sale');
    window.open(`https://www.google.com/search?q=${searchQuery}`, '_blank');
}

function contactDealer(carTitle) {
    const message = `I'm interested in the ${carTitle} recommended by your AI Car Advisor. Please provide more details.`;
    window.location.href = `mailto:nextcarconcierge@gmail.com?subject=Interest in ${encodeURIComponent(carTitle)}&body=${encodeURIComponent(message)}`;
}

async function upgradeToFullService() {
    try {
        const response = await fetch('/api/create-upsell-payment', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ service: 'premium_concierge' })
        });
        
        const { sessionId } = await response.json();
        
        const { error } = await stripe.redirectToCheckout({ sessionId: sessionId });
        
        if (error) {
            alert('Payment failed. Please try again.');
        }
        
    } catch (error) {
        alert('Payment failed. Please try again.');
    }
}

// Handle payment verification on page load
window.addEventListener('load', function() {
    const urlParams = new URLSearchParams(window.location.search);
    const sessionId = urlParams.get('session_id');
    
    if (sessionId) {
        verifyPayment(sessionId);
    }
    
    // Focus on input
    document.getElementById('messageInput').focus();
});

async function verifyPayment(sessionId) {
    try {
        const response = await fetch('/api/verify-payment', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ sessionId })
        });
        
        const data = await response.json();
        
        if (data.success) {
            localStorage.setItem('chatToken', data.chatToken);
        }
    } catch (error) {
        console.error('Verification error:', error);
    }
}

// Enter key support
document.getElementById('messageInput').addEventListener('keydown', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        sendUserMessage();
    }
});
</script>

</body>
</html>
